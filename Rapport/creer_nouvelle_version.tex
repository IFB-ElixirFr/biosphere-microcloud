\chapter{Mettre à jour des composants pour MicroCloud} \label{chap:creer_nouvelle_version}

Ce chapitre présente les commandes utilisées pour créer une nouvelle version
des fichiers contenant le code et les données qui seront utilisés
par les scripts d'installation des VM pour déployer MicroScope.
Ces opérations doivent être effectuées au Genoscope.
Les détails techniques sont dans le~\autoref{chap:micwebdeploy}.
Le répertoire d'export des archives et autres fichiers sur etna0 est \path{/env/cns/wwwext/html/agc/ftp/MicroCloud/}.
\bigskip

Les composants nécessaires sont:
\begin{itemize}
    \item Le code web et les bases de données (schéma + données de base) de l'instance (voir~\autoref{sec:nouvelle_version_web})
          qui sont installés par la VM frontend.
    \item Les données d'un organisme (voir~\autoref{sec:nouvelle_donne_organisme})
          qui sont aussi utilisées par la VM frontend.
    \item Les modules à installer (voir~\autoref{sec:nouvelle_liste_modules}).
    \item \component{jbpmmicroscope} (voir~\autoref{sec:nouvelle_version_jbpmmicroscope}).
\end{itemize}

La plupart des ces opérations utilisent le module \micWEBdeployVer.
Pour le charger:
\begin{lstlisting}[style=bash]
$ module load micWEBdeploy/0-MicroCloud-1.0
\end{lstlisting}

\section{Créer une nouvelle release du code web} \label{sec:nouvelle_version_web}

Pour créer une nouvelle version du code du web et des bases de données, choisir la version de MicroScope à déployer puis lancer le script \script{microscopeRelease.py} :
\begin{lstlisting}[style=bash]
$ MICVERSION=3.14.0
$ microscopeRelease.py --version ${MICVERSION} --output /env/cns/wwwext/html/agc/ftp/MicroCloud/microcloud-${MICVERSION}.tar.gz
\end{lstlisting}

Ensuite, mettre à jour le lien symbolique pour qu'il pointe vers la nouvelle archive :
\begin{lstlisting}[style=bash]
$ cd /env/cns/wwwext/html/agc/ftp/MicroCloud
$ ln -s microcloud-${MICVERSION}.tar.gz microcloud-latest.tar.gz
\end{lstlisting}

\section{Copier les données d'un organisme} \label{sec:nouvelle_donne_organisme}

Comme MicroScope ne peut pas fonctionner sans données, nous avons crée un système
pour importer les données syntaxique d'un organisme.

Pour créer une archive des données d'un organisme, utiliser le script \script{microscopeCopyOid.py} de la manière suivante :
\begin{lstlisting}[style=bash]
$ Oid=31
$ microscopeCopyOid.py --oid ${Oid} --output /env/cns/wwwext/html/agc/ftp/MicroCloud/microscope_${Oid}.tar.gz
\end{lstlisting}

\begin{mycolorbox}
    Pour le moment seules les données concernant l'O\_id 31 peuvent être récupérées avec le script microscopeCopyOid.py car certains organismes ont besoin de tables spécifiques de la base GO\_SPE (typiquement la table acineto\_KO pour Acinetobacter baylyi).
    C'est cet organisme qui est installé dans MicroCloud.
\end{mycolorbox}

Ensuite, mettre à jour le lien symbolique pour qu'il pointe vers la nouvelle archive :
\begin{lstlisting}[style=bash]
$ Oid=31
$ cd /env/cns/wwwext/html/agc/ftp/MicroCloud
$ ln -s microscope_${Oid}.tar.gz microscope_${Oid}-latest.tar.gz
\end{lstlisting}

\section{Mettre à jour la liste des modules} \label{sec:nouvelle_liste_modules}

Lors du déploiement de l'instance, un certain nombre de modules sont installés.
Pour mettre à jour cette liste, il faut utiliser le script \script{createModulesTarball.py}.

En premier lieu, faire la liste de tous les modules nécessaires à la création de la nouvelle instance MicroCloud et utiliser
le script \script{createModulesTarball.py} pour générer les archives de ces modules:
\begin{lstlisting}[style=bash]
$ createModulesTarball.py --modules_list bagsub-2.4.3 AGCScriptToolMic-2.0 micGenome-7.0.0 micJBPMwrapper-3.10.8 micPrestation-2.0 micDirecton-1.0
\end{lstlisting}

Actuellement l'environnement de MicroCloud ne permet d'utiliser que les modules \module[2.4.3]{bagsub}, \module[2.0]{AGCScriptToolMic}, \module[7.0.0]{micGenome}, \module[3.10.8]{micJBPMwrapper}, \module[2.0]{micPrestation} et \module[1.0]{micDirecton}.
\newline

\begin{mycolorbox}
    Lors de tout ajout de nouveaux modules, il faut modifier le script de l'étape Depolyment de la VM master
    pour faut ajouter les variables d'environnement nécessaires aux les nouveaux modules
    dans le fichier \path{microcloud.profile}.
\end{mycolorbox}

\section{Mettre à jour jbpmmicroscope} \label{sec:nouvelle_version_jbpmmicroscope}

Dans cette section JBPMmicroscope peut faire référence à la base de données JBPMmicroscope ou bien à la commande JBPMmicroscope qui permet le déploiement des workflows.
\newline

Pour mettre à jour jbpmmicroscope, il faut avant tout récupérer le projet jbpmmicroscope depuis le dépôt SVN puis regénérer les fichiers suivants :
\begin{itemize}
    \item \script{jbpmmicroscope.jar}
    \item \script{SystemActorsLauncher.jar}
    \item \script{jbpmmicroscope-server.war}
\end{itemize}
\bigskip

Pour ce faire, il faut déjà mettre à jour le fichier \path{~/.m2/genosphere-settings.xml} :
\begin{itemize}
    \item Mettre à jour le local path
    \item Supprimer/modifier le login et le mot de passe
\end{itemize}
\bigskip

Ensuite, pour créer les .jar dans le répertoire \path{jbpmmicroscope-client/target/} faire :

\begin{lstlisting}[style=bash]
$ mvn -Pconfig-microcloud -s ~/.m2/genosphere-settings.xml clean install
\end{lstlisting}
\bigskip

Il faut ajouter les sources (qui sont nécessaires pour le déploiement des workflows dans les VM) et le script JBPMmicroscope (qui permet de lancer bagsub) :
\begin{lstlisting}[style=bash]
$ jar uf jbpmmicroscope-client/target/jbpmmicroscope.jar -C ./ src/
$ jar uf jbpmmicroscope-client/target/jbpmmicroscope.jar -C ./ JBPMmicroscope
\end{lstlisting}
\bigskip

Pour créer l'archive \path{jbpmmicroscope-server.war} dans le répertoire \path{jbpmmicroscope-server/target/} :
\begin{lstlisting}[style=bash]
$ mvn -Pconfig-microcloud -s ~/.m2/genosphere-settings.xml package
\end{lstlisting}
\bigskip

Copier le .war et les .jar sur etna0 dans le répertoire \path{/env/cns/wwwext/html/agc/ftp/MicroCloud/}.
La VM master importe ces fichiers à l'aide des liens symboliques.
\newline

Le schéma de la base JBPMmicroscope est créé automatiquement par hibernate (\script{hibernate.cfg.xml} voir le paramètre \textbf{hbm2ddl.auto}) lors de la première exécution d'une commande JBPMmicroscope.
\newline

Les identifiants de connexion à la base JBPMmicroscope (via hibernate) sont les suivants :
login=\textbf{jbpm} et password=\textbf{jbpm}. Ces identifiants peuvent être modifiés dans le composant master, ils correspondent aux paramètres \textbf{jbpm\_user} et \textbf{jbpm\_password} (si vous souhaitez modifier ces identifiants, il faut bien penser à mettre à jour le fichier \path{hibernate.cfg.xml}, régénérer les .jar et le .war et les copier dans \path{/env/cns/wwwext/html/agc/ftp/MicroCloud}).
\newline

jbpmmicroscope nécessite un serveur Tomcat pour fonctionner. Tomcat 9 est installé dans le composant master : \path{/env/cns/proj/agc/tools/COMMON/JBPMmicroscope/tomcat}. Les identifiants tomcat sont les suivants : login=\textbf{tomcat} et password=\textbf{tomcat}.
Ces identifiants peuvent être modifiés dans le composant master, ils correspondent aux paramètres \textbf{tomcat\_user} et \textbf{tomcat\_password}.

\section{Mettre à jour la VM permanente}
\todo{Compléter cette partie + ajouter un lien au début}

Il faut penser à mettre à jour les tables de la VM permanente en fonction des besoins. Pour cela, s'inspirer du script \script{microscopeCreateDBschemas.py}, par exemple, et utiliser les fichiers de données ainsi générés.
\bigskip

Pour copier les données, mieux vaut utiliser rsync et copier les données dans le répertoire \textbf{/var/lib/mysql-files/} de la VM permanente avant insertion en base :
\begin{lstlisting}[style=bash]
$ LOAD DATA INFILE '/var/lib/mysql-files/$file.DB' INTO TABLE $table;
\end{lstlisting}
