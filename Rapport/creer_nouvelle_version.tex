\chapter{Mettre à jour des composants pour MicroCloud} \label{chap:creer_nouvelle_version}

\begin{mycolorbox}
	METTRE ICI LES COMMANDES POUR CRÉER DES RELEASES, COPIER DES BASES, etc.
\end{mycolorbox}

Ce chapitre présente les commandes utilisées pour créer une nouvelle version
du code et des données qui seront déployées sur le cloud.
Ces opérations utilisent le module \micWEBdeployVer
et doivent être effectuées au Genoscope.
Par convention le répertoire d'export des archives et autres fichiers sur etna0: \path{/env/cns/wwwext/html/agc/ftp/MicroCloud/}.
\bigskip

Pour charger le module \micWEBdeployVer:
\begin{lstlisting}[style=bash]
$ module load micWEBdeploy/0-MicroCloud-1.0
\end{lstlisting}

\section{Créer une nouvelle release du code web}

Pour créer une nouvelle version du code du web et des bases de données:
\begin{lstlisting}[style=bash]
$ MICVERSION=3.14.0
$ microscopeRelease.py --version ${MICVERSION} --output /env/cns/wwwext/html/agc/ftp/MicroCloud/microcloud-${MICVERSION}.tar.gz
\end{lstlisting}

Ensuite, mettre à jour le lien symbolique pour qu'il pointe vers la nouvelle archive :
\begin{lstlisting}[style=bash]
$ cd /env/cns/wwwext/html/agc/ftp/MicroCloud
$ ln -s microcloud-${MICVERSION}.tar.gz microcloud-latest.tar.gz
\end{lstlisting}

\section{Copier les données d'un organisme}

Permet de copier les données de l'organisme \textit{Acinetobacter baylyi} (O\_id=31).

\begin{mycolorbox}
	Pour le moment seules les données concernant l'O\_id 31 peuvent être récupérées avec le script microscopeCopyOid.py car certains organismes ont besoin de tables spécifiques de la base GO\_SPE (typiquement la table acineto\_KO pour Acinetobacter baylyi).
\end{mycolorbox}

\begin{lstlisting}[style=bash]
$ Oid=31
$ microscopeCopyOid.py --oid ${Oid} --output /env/cns/wwwext/html/agc/ftp/MicroCloud/microscope_${Oid}.tar.gz
\end{lstlisting}

Ensuite, mettre à jour le lien symbolique pour qu'il pointe vers la nouvelle archive :
\begin{lstlisting}[style=bash]
$ Oid=31
$ cd /env/cns/wwwext/html/agc/ftp/MicroCloud
$ ln -s microscope_${Oid}.tar.gz microscope_${Oid}-latest.tar.gz
\end{lstlisting}

\section{Mettre à jour jbpmmicroscope}

Dans cette section JBPMmicroscope peut faire référence à la base de données JBPMmicroscope ou bien à la commande JBPMmicroscope qui permet le déploiement des WF.
\newline

Il faut générer les fichiers suivants :
\begin{itemize}
	\item \script{jbpmmicroscope.jar}
	\item \script{SystemActorsLauncher.jar}
	\item \script{jbpmmicroscope-server.war}
\end{itemize}
\bigskip

Puis mettre à jour le fichier \path{~/.m2/genosphere-settings.xml} :
\begin{itemize}
	\item  Mettre à jour le local path
	\item Supprimer/modifier le login et le mot de passe
\end{itemize}

Pour créer les .jar dans le répertoire \path{jbpmmicroscope-client/target/} faire :

\begin{lstlisting}[style=bash]
$ mvn -Pconfig-microcloud -s ~/.m2/genosphere-settings.xml clean install
\end{lstlisting}
\bigskip

Il faut ajouter les sources (pour le déploiement des WF) et le script JBPMmicroscope
\begin{lstlisting}[style=bash]
$ jar uf jbpmmicroscope-client/target/jbpmmicroscope.jar -C ./ src/
$ jar uf jbpmmicroscope-client/target/jbpmmicroscope.jar -C ./ JBPMmicroscope
\end{lstlisting}
\bigskip

Pour créer l'archive \path{jbpmmicroscope-server.war} dans le répertoire \path{jbpmmicroscope-server/target/} :
\begin{lstlisting}[style=bash]
$ mvn -Pconfig-microcloud -s ~/.m2/genosphere-settings.xml package
\end{lstlisting}
\bigskip

Copier le .war et les .jar sur etna0 dans le répertoire \path{/env/cns/wwwext/html/agc/ftp/MicroCloud/}
La VM master importe ces fichiers à l’aide des liens symboliques.
\newline

Le schéma de la base JBPMmicroscope est créé automatiquement par hibernate (\script{hibernate.cfg.xml} voir le paramètre \textbf{hbm2ddl.auto}) lors de la première exécution d'une commande JBPMmicroscope.
\newline

Les identifiants de connexion à la base JBPMmicroscope (hibernate) sont les suivants :
login: \textbf{jbpm} et password: \textbf{jbpm}. Ces identifiants peuvent être modifiés dans le composant master, ils correspondent aux paramètres \textbf{jbpm\_user} et \textbf{jbpm\_password} (penser à mettre à jour le fichier \path{hibernate.cfg.xml}, régénérer les .jar et le .war et les copier dans \path{/env/cns/wwwext/html/agc/ftp/MicroCloud}).
\newline

jbpmmicroscope nécessite un serveur Tomcat pour fonctionner. Tomcat 9 est installé dans le composant master : \path{/env/cns/proj/agc/tools/COMMON/JBPMmicroscope/tomcat}. Les identifiants tomcat sont les suivants : login: \textbf{tomcat} et password: \textbf{tomcat}.
Ces identifiants peuvent être modifiés dans le composant master, ils correspondent aux paramètres \textbf{tomcat\_user} et \textbf{tomcat\_password}.

\section{Mettre à jour la VM permanente}
\todo{compléter cette partie}
Pour cela s'inspirer du script \script{microscopeCreateDBschemas.py}, copier les fichiers ainsi générés sur la VM permanente et les insérer en base.

\section{Mettre à jour les scripts côtés serveur}

Mettre à jour (si besoin) les scripts \script{import\_Oid.sh} et \script{install\_microscope.sh}.
