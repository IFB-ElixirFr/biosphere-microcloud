\chapter{Déployer une instance MicroCloud et l'utiliser} \label{chap:deploiement}

Ce chapitre décrit l'utilisation de MicroCloud d'un point de vue utilisateur.
Le lecteur est invité à lire la documentation sur le cloud IFB
(voir \href{https://intranet.genoscope.cns.fr/agc/redmine/documents/86}{les documents de la formation IFB},
\href{https://intranet.genoscope.cns.fr/agc/redmine/issues/6010}{la demande liée}
et la page \href{https://intranet.genoscope.cns.fr/agc/redmine/projects/microcloud/wiki/Principes_de_fonctionnement_du_cloud_IFB}{[[Principes de fonctionnement du cloud IFB]]}
dans le projet Redmine).

\section{Déployer l'appliance MicroCloud}

L'appliance MicroCloud est disponible dans le catalogue RAINBio \url{https://biosphere.france-bioinformatique.fr/catalogue/appliance/150/}.
Pour déployer l'appliance, cliquer sur \textbf{Lancer}.
En utilisant \textbf{Déploiement avancé}, on peut choisir le nombre de nœuds de calculs.

Les déploiements se font sur le cloud \cloudInstance{ifb-prabi-girofle} sur lequel est installé la \hyperref[VM permanente]{VM permanente}.
Un déploiement prend environ 40 minutes.

Il y a 2 points d'entrée du déploiement:
\begin{enumerate}
	\item \emph{L'interface web:} L'URL de la plateforme est: \nolinkurl{https://${IP_frontend}/home/index.php} où \nolinkurl{${IP_frontend}}
	      est l'IP de la machine frontend.
	      Cette URL est reporté dans l'interface RAINBio.
	\item \emph{La machine frontale du cluster:} On peut aussi se connecter en SSH à la machine frontale du cluster
	      dont l'IP est aussi reportée dans l'interface de RAINBio.
	      Cette machine comprend les modules nécessaire au travail avec une instance (\module{micGenome}, \module{micJBPMwrapper}, etc.)
	      et \component{jbpmmicroscope} pour déployer les WF.
	      La plupart des chemins sont identique
\end{enumerate}
L'instance fournie contient les données de \textit{Acinetobacter baylyi} ADP1.
Cependant, l'instance fournie ne contient pas d'utilisateur
et aucun WF n'est configuré sur l'instance.
De plus, les logiciels métier des WF ne sont pas installés.

\section{Créer un nouvel utilisateur admin}

Une fois l'instance déployée, on peut créer un utilisateur admin.

Pour cela, il faut se connecter en ssh à la frontale puis exécuter le script \script{create\_user.sh}:
\begin{lstlisting}[style=Bash]
	ssh centos@${IP_master}
	cd \path{/var/tmp/slipstream/biosphere-microcloud/master}
	./create_user.sh LOGIN EMAIL admin
\end{lstlisting}
Le script demande le mot de passe à utiliser et crée l'utilisateur

\section{Insérer un nouvel organisme (partie Syntactic)}

La première étape est d'ajouter les données de taxonomie pour ce nouvel organisme.
Pour cela, il faut mettre à jour la base TAXONOMYDB de la VM permanente :
\begin{itemize}
	\item en copiant les données de prod de TAXONOMYDB et pkgdb.O\_Taxonomy pour cet organisme
	\item ou en déployant les WF TAXONOMYDB et TAXONOMY
\end{itemize}
\bigskip

Pour insérer un nouvel organisme, on utilise le module \module{micPrestation}.
La procédure à suivre est la suivante :
\begin{itemize}
	\item Télécharger un fasta et décompresser l'archive.
	\item Remplir le fichier Template\_Prestation.csv qui trouve dans le répertoire \path{/env/cns/proj/agc/module/products/micsyntactic/unix-noarch/lib}
	\item Lancer la création de la prestation:
\begin{lstlisting}[style=bash]
$ prestaBatch.py --csv Template_Prestation.csv -sd ${working_dir} -A ${Annotator_name} -T genome
\end{lstlisting}
        Il y a un exemple de fichier Template\_Prestation.csv dans le dossier prestation : \path{/env/cns/wwwext/html/agc/ftp/MicroCloud/prestation}.
    \item Accepter la prestation:
    \begin{itemize}
    	\item Depuis le web (avec l'utilisateur admin crée à la section précédente).
    	\item Pour valider la prestation sans passer par le web faire :
    	\begin{lstlisting}[style=SQL]
    		USE PRESTATIONDB;
    		SELECT * FROM Prestation;
    		UPDATE Prestation SET PS_status='accepted' WHERE PS_status='inprogress';
    	\end{lstlisting}
    \end{itemize} 
\end{itemize}


\begin{lstlisting}[style=bash]
$ loadGenomeNS.sh -p ${PS_id} -o ${O_id}
\end{lstlisting}

\begin{mycolorbox}
	Les données des banques nécessaires pour le script \textbf{loadGenomeNS.sh} ne sont pas stockées dans la VM permanente actuellement (données des banques gérées par CABRI).
	Cette étape ne fonctionne donc pas.
\end{mycolorbox}
\todo[inline]{Quelles banques ? TAXONOMY ? Mettre à jour la référence dans les limites}

\section{Déployer un WF}

Les workflows sont déployés sur la VM master. A ce jour nous n'avons pu tester que le workflow DIRECTON. Les sources du moteur de workflow jBPM sont dans le répertoire \path{/env/cns/proj/agc/tools/COMMON/JBPMmicroscope/jbpmmicroscope}.
Le répertoire de travail Tomcat est le suivant : \path{/env/cns/proj/agc/tools/COMMON/JBPMmicroscope/tomcat}.
Les modules sont localisés dans le répertorie : \path{/env/cns/proj/agc/module/products}
\newline

\begin{mycolorbox}
	Si les données ont été copiées depuis la prod et insérées telles quelles (sans micPrestation), il faut, dans la table pkgdb.Sequence, vérifier que le status des S\_id existants soit 'inFunctional' et non 'inProduction' pour que les WF prennent bien en compte les nouveaux S\_id.
\end{mycolorbox}

\begin{lstlisting}[style=SQL]
USE pkgdb;
UPDATE Sequence SET S_status='inFunctional' WHERE S_status='inProduction';
\end{lstlisting}

\subsection{Déployer le WF DIRECTON}
Les modules requis pour le bon déploiement de ce workflow sont les suivants : \textbf{bagsub-2.4.3}, \textbf{AGCScriptToolMic-2.0}, \textbf{micGenome-7.0.0}, \textbf{micJBPMwrapper-3.10.8} et \textbf{micPrestation-2.0} et \textbf{micDirecton-1.0}.

\begin{lstlisting}[style=bash]
#### Deploy DIRECTON WF ####
$ cd /env/cns/proj/agc/tools/COMMON/JBPMmicroscope/tomcat/

# Deploy WF
$ JBPMmicroscope deployProcess -dirXMLSrc ../jbpmmicroscope/src/main/process-definitions/jpdl/BagSub/ -defNames DIRECTON

# Deploy and start CRON
$ JBPMmicroscope deployProcess -dirXMLSrc ../jbpmmicroscope/src/main/process-definitions/jpdl -defNames CRON_DIRECTON
JBPMmicroscope startCron -names CRON_DIRECTON

# Check CRON and WF status
$ JBPMmicroscope showProcessDefinitions

# Force run
$ JBPMmicroscope signalCron -names CRON_DIRECTON -signal forceRun; JBPMmicroscope signalProcess -pid 1

$ JBPMmicroscope showProcessInstances

# Take a look at running processes
$ tomcat_logs

# relaunch WF if status is sendmail
$ JBPMmicroscope relaunchAnalysis -pidCron 1 -pidWF 2 -signal forceRun

# Check tables pkgdb.Workflow_Jobs, pkgdb.Directon and pkgdb.GO_Directon_CPD
$ mysqlagcdb
\end{lstlisting}
