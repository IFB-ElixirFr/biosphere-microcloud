\chapter{Module \micWEBdeployVer} \label{chap:micwebdeploy}

Ce module contient les scripts utilisés côté Genoscope pour gérer les fichiers (logiciels et les données) nécessaires pour déployer MicroCloud (voir~\autoref{chap:creer_nouvelle_version}).
C'est une version de développement basée sur \module[1.0]{micWEBdeploy}.

Il est constitué des scripts suivants :
\begin{description}
    \item[\script{microscopeRelease.py}] : copie le code du web, compile le code JavaScript (avec \script{microscopeCompileJS.sh}), copie les schémas de certaines bases et les données minimales de certaines bases.
    \item[\script{microscopeCopyOid.py}] : permet de copier les données de l'organisme \theOrg{} (Oid=\theOid)
    \item[\script{createModulesTarball.py}]: créé les archives des modules à importer dans MicroCloud.
\end{description}

Comme expliqué, ce module est très lié aux scripts de déploiement des VM.

\section{\script{microscopeRelease.py}}

Les schémas copiés sont : pkgdb, REFSEQDB, GO\_Conf, GO\_RES, GO\_CPD, PUB\_CPD et PRESTATIONDB.

Les données copiées sont : pkgdb (tables : Maintenance, Country, Amiga\_Params,
Annotator pour A\_name='guest', Sequence\_Checkpoint\_Desc et Sid\_Config), GO\_RES (tables : ORGCLUST\_clustering\_param et ORGCLUST\_distance\_param.
) et GO\_Conf (prendre les données de toutes les tables). Voir page wiki : \url{https://intranet.genoscope.cns.fr/agc/redmine/projects/microcloud/wiki/Tables_necessaires_a_installation}


\section{\script{createModulesTarball.py}}

Créé les liens symboliques dans \path{/env/cns/wwwext/html/agc/ftp/MicroCloud}.
Créé le fichier \path{modules.txt} dans \path{/env/cns/wwwext/html/agc/ftp/MicroCloud}.
Puis, la VM master importe les modules listés dans modules.txt (voir \url{https://github.com/IFB-ElixirFr/biosphere-microcloud/blob/master/master/import_modules.sh}).

\begin{lstlisting}[style=bash]
createModulesTarball.py --modules_list bagsub-2.4.3 AGCScriptToolMic-2.0 micGenome-7.0.0 micJBPMwrapper-3.10.8 micPrestation-2.0 micDirecton-1.0
\end{lstlisting}

\section{\script{microscopeCopyOid.py}}

\begin{mycolorbox}
    Pour le moment seules les données concernant l'Oid \theOid{} peuvent être récupérées avec le script microscopeCopyOid.py car certains organismes ont besoin de tables spécifiques de la base GO\_SPE (typiquement la table acineto\_KO pour \theOrg{}).
\end{mycolorbox}

\begin{lstlisting}[style=bash]
Oid=(*\theOid{}*)
microscopeCopyOid.py --oid ${Oid} --output /env/cns/wwwext/html/agc/ftp/MicroCloud/microscope_${Oid}.tar.gz
\end{lstlisting}

\section{\script{microscopeCreateDBschemas.py}}
A permis de générer les .sql utilisés pour créer les schémas des bases de données dans la VM permanente.

\begin{lstlisting}[style=bash]
microscopeCreateDBschemas.py --output /env/cns/wwwext/html/agc/ftp/MicroCloud/DBschemas.tar.gz
\end{lstlisting}

\section{\script{taxonomyDBCopyTaxId.py}}
Permet de copier les données de la base TAXONOMYDB pour un tax\_id donné.

\begin{lstlisting}[style=bash]
taxonomyDBCopyTaxId.py --tax_id 202950 --output /env/cns/wwwext/html/agc/ftp/MicroCloud/taxonomyDBCopyTaxId.tar.gz
\end{lstlisting}
